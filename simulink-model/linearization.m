


J = sym('J',[3,3]);
syms phi dphi ddphi theta dtheta ddtheta psi dpsi ddpsi 
% omega = sym('omega',[3,1]);
ctrl = sym('ctrl',[4,1]);
d = 0.046;
b = 1.9796e-9;
k = 2.5383e-11;
omega = [dphi; dtheta; dpsi];
tau_x = d*sin(pi/4) * (ctrl(3) + ctrl(4) - ctrl(1) - ctrl(2));
tau_y = d*sin(pi/4) * (ctrl(2) + ctrl(3) - ctrl(1) - ctrl(4));
tau_z = (b/k)*(-ctrl(1)-ctrl(3)+ctrl(4)+ctrl(2));
tau = [tau_x tau_y tau_z].';
f =J\(cross(-omega,J*omega)+tau);

x0 = zeros(6,1);
ctrl0 = zeros(4,1);
x = [phi; theta; psi; omega]; 
xdot = [omega(1); omega(2); omega(3); f];
dfdx = jacobian(xdot,x)

dfdu = jacobian(xdot,ctrl)

Jx = 1.1463e-5;
Jy = 1.6993e-5;
Jz = 2.9944e-5;
J = [Jx,0,0;0,Jy,0;0,0,Jz];
J1_1 = J(1,1);
J1_2 = J(1,2);
J1_3 = J(1,3);
J2_1 = J(2,1);
J2_2 = J(2,2);
J2_3 = J(2,3);
J3_1 = J(3,1);
J3_2 = J(3,2);
J3_3 = J(3,3);
dphi = 0 %omega(1);
dtheta = 0 %omega(2);
dpsi = 0 %omega(3);
A =     [ 0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          1,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0
        0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  1,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0;
        0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1;
        0, 0, 0, -(J1_2*J2_3^2*dpsi + J1_2*J3_3^2*dpsi - J1_3*J2_2^2*dtheta - J1_3*J3_2^2*dtheta + 2*J1_2*J2_1*J2_3*dphi - 2*J1_3*J2_1*J2_2*dphi + 2*J1_2*J3_1*J3_3*dphi - 2*J1_3*J3_1*J3_2*dphi - J1_1*J1_2*J3_3*dpsi + J1_1*J1_3*J3_2*dpsi - J1_3*J2_2*J2_3*dpsi - J2_1*J2_2*J3_3*dpsi + J2_1*J2_3*J3_2*dpsi - J1_3*J3_2*J3_3*dpsi - J1_1*J1_2*J2_3*dtheta + J1_1*J1_3*J2_2*dtheta + J1_2*J2_2*J2_3*dtheta + J1_2*J3_2*J3_3*dtheta + J2_2*J3_1*J3_3*dtheta - J2_3*J3_1*J3_2*dtheta)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1),              (dpsi*J1_2^2*J3_3 + 2*J2_3*dtheta*J1_2^2 - 2*dtheta*J1_2*J1_3*J2_2 - dpsi*J1_2*J1_3*J3_2 + J2_3*dpsi*J1_2*J1_3 - J2_3*dphi*J1_2*J2_2 - dphi*J1_2*J3_2*J3_3 + J1_1*J2_3*dphi*J1_2 - dpsi*J1_3^2*J2_2 + dphi*J1_3*J2_2^2 - J1_1*dphi*J1_3*J2_2 + dphi*J1_3*J3_2^2 + dpsi*J2_2^2*J3_3 - 2*dtheta*J2_2*J3_2*J3_3 - J2_3*dpsi*J2_2*J3_2 - dpsi*J2_2*J3_3^2 - J3_1*dphi*J2_2*J3_3 + 2*J2_3*dtheta*J3_2^2 + J2_3*dpsi*J3_2*J3_3 + J2_3*J3_1*dphi*J3_2)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1),          -(- dtheta*J1_2^2*J3_3 - dtheta*J1_2*J1_3*J2_3 - 2*dpsi*J1_2*J1_3*J3_3 + J3_2*dtheta*J1_2*J1_3 + dphi*J1_2*J2_3^2 + dphi*J1_2*J3_3^2 - J1_1*dphi*J1_2*J3_3 + dtheta*J1_3^2*J2_2 + 2*J3_2*dpsi*J1_3^2 - dphi*J1_3*J2_2*J2_3 - J3_2*dphi*J1_3*J3_3 + J1_1*J3_2*dphi*J1_3 - dtheta*J2_2^2*J3_3 - 2*dpsi*J2_2*J2_3*J3_3 + J3_2*dtheta*J2_2*J2_3 + dtheta*J2_2*J3_3^2 - J2_1*dphi*J2_2*J3_3 + 2*J3_2*dpsi*J2_3^2 - J3_2*dtheta*J2_3*J3_3 + J2_1*J3_2*dphi*J2_3)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1);
        0, 0, 0,             -(dtheta*J1_1^2*J2_3 + dpsi*J1_1^2*J3_3 - 2*dphi*J1_1*J2_1*J2_3 - J1_3*dtheta*J1_1*J2_1 - dpsi*J1_1*J2_3^2 - J2_2*dtheta*J1_1*J2_3 - 2*dphi*J1_1*J3_1*J3_3 - J1_3*dpsi*J1_1*J3_1 - dpsi*J1_1*J3_3^2 - J3_2*dtheta*J1_1*J3_3 + dpsi*J2_1^2*J3_3 + 2*J1_3*dphi*J2_1^2 - dpsi*J2_1*J2_3*J3_1 + J1_3*dpsi*J2_1*J2_3 - dtheta*J2_1*J3_1*J3_3 + J1_3*J2_2*dtheta*J2_1 + dtheta*J2_3*J3_1^2 + 2*J1_3*dphi*J3_1^2 + J1_3*dpsi*J3_1*J3_3 + J1_3*J3_2*dtheta*J3_1)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1), -(J1_1^2*J2_3*dphi + J2_3*J3_1^2*dphi - J1_3^2*J2_1*dpsi - J2_1*J3_3^2*dpsi - J1_1*J1_3*J2_1*dphi - J1_1*J2_2*J2_3*dphi + J1_3*J2_1*J2_2*dphi - J1_1*J3_2*J3_3*dphi + J1_3*J3_1*J3_2*dphi - J2_1*J3_1*J3_3*dphi + J1_1*J1_3*J2_3*dpsi + J1_1*J1_2*J3_3*dpsi - J1_2*J1_3*J3_1*dpsi + J2_1*J2_2*J3_3*dpsi - J2_2*J2_3*J3_1*dpsi + J2_3*J3_1*J3_3*dpsi + 2*J1_1*J1_2*J2_3*dtheta - 2*J1_2*J1_3*J2_1*dtheta - 2*J2_1*J3_2*J3_3*dtheta + 2*J2_3*J3_1*J3_2*dtheta)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1),           (- dphi*J1_1^2*J3_3 - dtheta*J1_1*J1_3*J2_3 - 2*dpsi*J1_1*J1_3*J3_3 + J3_1*dphi*J1_1*J1_3 + dphi*J1_1*J2_3^2 + dphi*J1_1*J3_3^2 - J1_2*dtheta*J1_1*J3_3 + dtheta*J1_3^2*J2_1 + 2*J3_1*dpsi*J1_3^2 - dphi*J1_3*J2_1*J2_3 - J3_1*dphi*J1_3*J3_3 + J1_2*J3_1*dtheta*J1_3 - dphi*J2_1^2*J3_3 - 2*dpsi*J2_1*J2_3*J3_3 + J3_1*dphi*J2_1*J2_3 + dtheta*J2_1*J3_3^2 - J2_2*dtheta*J2_1*J3_3 + 2*J3_1*dpsi*J2_3^2 - J3_1*dtheta*J2_3*J3_3 + J2_2*J3_1*dtheta*J2_3)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1);
         0, 0, 0,              (dtheta*J1_1^2*J2_2 + dpsi*J1_1^2*J3_2 - 2*dphi*J1_1*J2_1*J2_2 - J1_2*dtheta*J1_1*J2_1 - dtheta*J1_1*J2_2^2 - J2_3*dpsi*J1_1*J2_2 - 2*dphi*J1_1*J3_1*J3_2 - J1_2*dpsi*J1_1*J3_1 - dtheta*J1_1*J3_2^2 - J3_3*dpsi*J1_1*J3_2 + dpsi*J2_1^2*J3_2 + 2*J1_2*dphi*J2_1^2 - dpsi*J2_1*J2_2*J3_1 + J1_2*dtheta*J2_1*J2_2 - dtheta*J2_1*J3_1*J3_2 + J1_2*J2_3*dpsi*J2_1 + dtheta*J2_2*J3_1^2 + 2*J1_2*dphi*J3_1^2 + J1_2*dtheta*J3_1*J3_2 + J1_2*J3_3*dpsi*J3_1)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1),           -(- dphi*J1_1^2*J2_2 - 2*dtheta*J1_1*J1_2*J2_2 - dpsi*J1_1*J1_2*J3_2 + J2_1*dphi*J1_1*J1_2 + dphi*J1_1*J2_2^2 - J1_3*dpsi*J1_1*J2_2 + dphi*J1_1*J3_2^2 + dpsi*J1_2^2*J3_1 + 2*J2_1*dtheta*J1_2^2 - J2_1*dphi*J1_2*J2_2 - dphi*J1_2*J3_1*J3_2 + J1_3*J2_1*dpsi*J1_2 + dpsi*J2_2^2*J3_1 - dphi*J2_2*J3_1^2 - 2*dtheta*J2_2*J3_1*J3_2 - J3_3*dpsi*J2_2*J3_1 - J2_1*dpsi*J2_2*J3_2 + J2_1*dphi*J3_1*J3_2 + 2*J2_1*dtheta*J3_2^2 + J2_1*J3_3*dpsi*J3_2)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1), (J1_1^2*J3_2*dphi + J2_1^2*J3_2*dphi - J1_2^2*J3_1*dtheta - J2_2^2*J3_1*dtheta - J1_1*J1_2*J3_1*dphi - J1_1*J2_2*J2_3*dphi + J1_2*J2_1*J2_3*dphi - J2_1*J2_2*J3_1*dphi - J1_1*J3_2*J3_3*dphi + J1_2*J3_1*J3_3*dphi + 2*J1_1*J1_3*J3_2*dpsi - 2*J1_2*J1_3*J3_1*dpsi + 2*J2_1*J2_3*J3_2*dpsi - 2*J2_2*J2_3*J3_1*dpsi + J1_1*J1_3*J2_2*dtheta - J1_2*J1_3*J2_1*dtheta + J1_1*J1_2*J3_2*dtheta + J2_1*J2_2*J3_2*dtheta - J2_1*J3_2*J3_3*dtheta + J2_2*J3_1*J3_3*dtheta)/(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)]
     
     
B =   [                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0;
                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0;
                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                          0;
 -(1404928625039220480*J1_2*J2_3 - 1404928625039220480*J1_3*J2_2 - 585952753872371*J1_2*J3_3 + 585952753872371*J1_3*J3_2 + 585952753872371*J2_2*J3_3 - 585952753872371*J2_3*J3_2)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)),  (1404928625039220480*J1_2*J2_3 - 1404928625039220480*J1_3*J2_2 - 585952753872371*J1_2*J3_3 + 585952753872371*J1_3*J3_2 - 585952753872371*J2_2*J3_3 + 585952753872371*J2_3*J3_2)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)), -(1404928625039220480*J1_2*J2_3 - 1404928625039220480*J1_3*J2_2 + 585952753872371*J1_2*J3_3 - 585952753872371*J1_3*J3_2 - 585952753872371*J2_2*J3_3 + 585952753872371*J2_3*J3_2)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)),  (1404928625039220480*J1_2*J2_3 - 1404928625039220480*J1_3*J2_2 + 585952753872371*J1_2*J3_3 - 585952753872371*J1_3*J3_2 + 585952753872371*J2_2*J3_3 - 585952753872371*J2_3*J3_2)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1));
  (1404928625039220480*J1_1*J2_3 - 1404928625039220480*J1_3*J2_1 - 585952753872371*J1_1*J3_3 + 585952753872371*J1_3*J3_1 + 585952753872371*J2_1*J3_3 - 585952753872371*J2_3*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)), -(1404928625039220480*J1_1*J2_3 - 1404928625039220480*J1_3*J2_1 - 585952753872371*J1_1*J3_3 + 585952753872371*J1_3*J3_1 - 585952753872371*J2_1*J3_3 + 585952753872371*J2_3*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)),  (1404928625039220480*J1_1*J2_3 - 1404928625039220480*J1_3*J2_1 + 585952753872371*J1_1*J3_3 - 585952753872371*J1_3*J3_1 - 585952753872371*J2_1*J3_3 + 585952753872371*J2_3*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)), -(1404928625039220480*J1_1*J2_3 - 1404928625039220480*J1_3*J2_1 + 585952753872371*J1_1*J3_3 - 585952753872371*J1_3*J3_1 + 585952753872371*J2_1*J3_3 - 585952753872371*J2_3*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1));
 -(1404928625039220480*J1_1*J2_2 - 1404928625039220480*J1_2*J2_1 - 585952753872371*J1_1*J3_2 + 585952753872371*J1_2*J3_1 + 585952753872371*J2_1*J3_2 - 585952753872371*J2_2*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)),  (1404928625039220480*J1_1*J2_2 - 1404928625039220480*J1_2*J2_1 - 585952753872371*J1_1*J3_2 + 585952753872371*J1_2*J3_1 - 585952753872371*J2_1*J3_2 + 585952753872371*J2_2*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)), -(1404928625039220480*J1_1*J2_2 - 1404928625039220480*J1_2*J2_1 + 585952753872371*J1_1*J3_2 - 585952753872371*J1_2*J3_1 - 585952753872371*J2_1*J3_2 + 585952753872371*J2_2*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1)),  (1404928625039220480*J1_1*J2_2 - 1404928625039220480*J1_2*J2_1 + 585952753872371*J1_1*J3_2 - 585952753872371*J1_2*J3_1 + 585952753872371*J2_1*J3_2 - 585952753872371*J2_2*J3_1)/(18014398509481984*(J1_1*J2_2*J3_3 - J1_1*J2_3*J3_2 - J1_2*J2_1*J3_3 + J1_2*J2_3*J3_1 + J1_3*J2_1*J3_2 - J1_3*J2_2*J3_1))]